%html
  %head
    %title GEO APP
    %link{ :rel=>"stylesheet", :href=>"/bootstrap/css/bootstrap.min.css", :type => "text/css" }
    %style{:type=>"text/css"}
      :plain
        #map_canvas { height: 90% }
    %script{ :type=>"text/javascript", :src=>"https://maps.googleapis.com/maps/api/js?key=AIzaSyA1l3GrctMRBhHg7V1htQvP_3_b5jggUuY&sensor=true"}
    %script{ :type=>"text/javascript", :src=>"http://code.jquery.com/jquery-latest.js"}
    %script{ :type=>"text/javascript", :src=>"/bootstrap/js/bootstrap.min.js"}
    %script{:type=>"text/javascript"}
      :plain
        var map;
        function initialize() {
          var mapOptions = {
            center: new google.maps.LatLng(31.230393, 121.473704),
            zoom: 8,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };

          map = new google.maps.Map(
            document.getElementById("map_canvas"),
            mapOptions);
        }
  %body{:onload => "initialize()"}
    %div.row
      %div.span6.offset1
        %legend Raw
        %dl.dl-horizontal
          - @payloadRaw.each do |key, value|
            %dt #{key}
            %dd #{value}
        %legend Record
        - ["name", "province", "city", "county", "area", "street", "streetnumber", "landmark", "other"].each do |att|
          - if value = @payload[att]
            %label.checkbox
              %input{:type => "checkbox", :value => value, :checked => (att !~ /(?:name|area|landmark|other)/)} #{value} ===> #{att}
        %input#lat{:type => "hidden"}
        %input#lng{:type => "hidden"}
        %button.btn#geo-button geo
        %button.btn.btn-primary#revise-button revise
      %div.span8
        %legend Map
        %div#map_canvas
      %div.span6
        %legend Nearby
        %div.alert#msg
        %div#revise-results
        %button.btn.btn-primary#confirm-button confirm
    %script{:type=>"text/javascript"}
      :plain
        function geo_location() {
          var geo_value = "";

          $('input[type=checkbox]').each(function(n,e){
            var element = $(e);
            if(element.attr("checked") == "checked") {
              geo_value += element.val();
            }
          });

          $("#msg").html(geo_value);

          return geo_value;
        }

        $("#geo-button").click(function(){
          $.getJSON("geo.json",
            {address:geo_location()}, function(json){

            var lat = json["lat"];
            var lng = json["lng"];
            var f_add = json["formatted_address"];
            var location = new google.maps.LatLng(lat, lng);

            $("#lat").val(lat);
            $("#lng").val(lng);

            var options = {
              zoom: 15,
              center: location,
              mapTypeId: google.maps.MapTypeId.ROADMAP
            }

            map.setOptions(options);

            var marker = new google.maps.Marker({
              position: location,
              map: map,
              animation: google.maps.Animation.DROP,
              title:"星巴克, " + f_add
            });
          });
        });

        $("#revise-button").click(function(){
          var lat = $("#lat").val();
          var lng = $("#lng").val();
          if(lat == "" || lng =="") {
            alert("Location lat/lng is empty!");
          } else {
            $.getJSON("revise.json",
              {lat:lat, lng:lng}, function(json){
              data = json["records"];
              var html = "";
              $.each(data, function(i, item){
                html += "<label class='radio'>" +
                  "<input type='radio' name='location'>" + (i+1) + ". " + item.vicinity +
                  "</label>";

                var location = new google.maps.LatLng(item.lat, item.lng);
                new google.maps.Marker({
                  position: location,
                  map: map,
                  animation: google.maps.Animation.DROP,
                  title: item.name + "," + item.vicinity,
                  icon: "https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=" + (i+1) + "|B88A00|000000"
                });
              });
              $("#revise-results").html(html);
            });
          }
        });

        geo_location();

